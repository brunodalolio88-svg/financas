<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finan√ßas Pessoais</title>
    
    <script>
        if (!localStorage.getItem('usuario_logado')) {
            // window.location.href = '/login.html'; // Descomente em produ√ß√£o
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a', 900: '#14532d' },
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* Ajustes PC */
        @media (min-width: 1024px) {
            .sidebar { display: block !important; }
            .mobile-nav { display: none !important; }
            main { margin-left: 280px; padding: 2.5rem; max-width: 1600px; }
            
            /* Tabela PC */
            .pc-table-header { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; padding: 1rem; font-weight: bold; color: #9ca3af; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb; }
            .pc-table-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; align-items: center; padding: 1rem; border-bottom: 1px solid #f3f4f6; transition: background 0.2s; }
            .pc-table-row:hover { background-color: #f9fafb; cursor: pointer; }
        }
    </style>
</head>
<body class="text-gray-800 pb-24 lg:pb-0">

    <aside class="sidebar hidden fixed left-0 top-0 h-full w-72 bg-white border-r border-gray-100 z-50 flex flex-col justify-between">
        <div>
            <div class="p-6 border-b border-gray-50">
                <div class="flex items-center gap-3 mb-1">
                    <div class="w-10 h-10 bg-brand-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-500/30">
                        <i data-lucide="wallet" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-900 leading-tight">Finan√ßas</h1>
                        <p class="text-xs text-gray-400">Painel de Controle</p>
                    </div>
                </div>
                <div class="mt-6 flex items-center gap-3 bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <div class="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold text-xs" id="pc-avatar-initials">U</div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-bold text-gray-700 truncate" id="pc-user-name">Carregando...</p>
                        <p class="text-[10px] text-green-600 font-medium">‚óè Online</p>
                    </div>
                </div>
            </div>

            <nav class="p-4 space-y-1">
                <button onclick="mudarAba('resumo')" id="pc-tab-resumo" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i> Vis√£o Geral
                </button>
                <button onclick="mudarAba('entradas')" id="pc-tab-entradas" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all">
                    <i data-lucide="arrow-up-circle" class="w-5 h-5"></i> Receitas
                </button>
                <button onclick="mudarAba('saidas')" id="pc-tab-saidas" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all">
                    <i data-lucide="arrow-down-circle" class="w-5 h-5"></i> Despesas
                </button>
            </nav>
        </div>

        <div class="p-6">
             <button onclick="logout()" class="w-full flex items-center gap-2 px-4 py-3 text-sm font-medium text-red-500 hover:bg-red-50 rounded-xl transition-all">
                <i data-lucide="log-out" class="w-4 h-4"></i> Sair da conta
            </button>
        </div>
    </aside>

    <main>
        <header class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-8 pt-6 px-6 lg:px-0 lg:pt-0">
            <div class="lg:hidden flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Ol√°, <span id="mobile-user-name">...</span> üëã</h2>
                    <p class="text-xs text-gray-400" id="last-update">Sincronizando...</p>
                </div>
                <div class="w-9 h-9 bg-gray-100 rounded-full flex items-center justify-center text-gray-500" onclick="logout()">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </div>
            </div>

            <div class="hidden lg:block">
                <h2 id="page-title" class="text-2xl font-bold text-gray-900">Vis√£o Geral</h2>
                <p class="text-sm text-gray-400">Resumo financeiro deste m√™s.</p>
            </div>

            <div class="flex items-center bg-white rounded-full shadow-sm border border-gray-200 p-1 pl-4 gap-2 self-start lg:self-auto">
                <span id="mes-titulo" class="text-xs font-bold text-gray-700 capitalize whitespace-nowrap min-w-[90px] text-center">...</span>
                <div class="flex">
                    <button onclick="mudarMes(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-full text-gray-400 transition"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <button onclick="resetarHoje()" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-full text-gray-400 transition"><i data-lucide="calendar" class="w-4 h-4"></i></button>
                    <button onclick="mudarMes(1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-full text-gray-400 transition"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
            </div>
        </header>

        <div id="view-resumo" class="animate-fade-in space-y-6 px-6 lg:px-0">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gradient-to-br from-gray-900 to-gray-800 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden flex flex-col justify-between min-h-[200px]">
                    <div class="absolute right-0 top-0 p-6 opacity-5"><i data-lucide="wallet" class="w-32 h-32"></i></div>
                    <div>
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Saldo Atual</p>
                        <h2 class="text-4xl font-bold tracking-tight" id="total-saldo">---</h2>
                    </div>
                    <div class="flex gap-4 mt-6">
                        <div>
                            <p class="text-[10px] text-green-400 uppercase font-bold mb-0.5">Receitas</p>
                            <p class="font-bold text-sm" id="total-renda">---</p>
                        </div>
                        <div class="w-px bg-white/10"></div>
                        <div>
                            <p class="text-[10px] text-red-400 uppercase font-bold mb-0.5">Despesas</p>
                            <p class="font-bold text-sm" id="total-gastos">---</p>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 bg-white rounded-3xl p-6 border border-gray-100 shadow-sm flex flex-col items-center justify-center relative">
                    <h3 class="absolute top-6 left-6 font-bold text-sm text-gray-700">Gastos por Categoria</h3>
                    <div class="h-40 w-full flex items-center justify-center mt-4">
                        <canvas id="graficoGastos"></canvas>
                        <p id="grafico-empty" class="hidden text-xs text-gray-400 absolute">Sem dados</p>
                    </div>
                </div>

                <div class="lg:col-span-1 bg-white rounded-3xl p-6 border border-gray-100 shadow-sm flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-sm text-gray-700">Investimentos</h3>
                        <button onclick="abrirModalContexto('investimento')" class="bg-brand-50 text-brand-600 p-1.5 rounded-lg hover:bg-brand-100 transition"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar" id="lista-investimentos">
                        </div>
                    <div class="mt-4 pt-4 border-t border-gray-50 flex justify-between items-center">
                        <span class="text-xs font-bold text-gray-400 uppercase">Total</span>
                        <span class="font-bold text-brand-600" id="total-investido">R$ 0,00</span>
                    </div>
                </div>
            </div>
            
            <button onclick="abrirModalEvolucao()" class="w-full bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 lg:hidden">
                <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Ver Evolu√ß√£o
            </button>
        </div>

        <div id="view-listas" class="hidden animate-fade-in px-6 lg:px-0 pb-24 lg:pb-0">
            <div class="hidden lg:block bg-white rounded-t-2xl border border-gray-200 border-b-0 mt-2">
                <div class="pc-table-header">
                    <div>Descri√ß√£o</div>
                    <div>Categoria</div>
                    <div>Data</div>
                    <div class="text-right">Valor</div>
                </div>
            </div>
            
            <div id="lista-content" class="space-y-3 lg:space-y-0 lg:bg-white lg:rounded-b-2xl lg:border lg:border-gray-200">
                </div>
        </div>

    </main>

    <button onclick="abrirModalContexto()" class="lg:hidden fixed bottom-24 right-6 bg-brand-600 text-white w-14 h-14 rounded-full shadow-xl shadow-brand-600/40 z-30 flex items-center justify-center transition-transform active:scale-90">
        <i data-lucide="plus" class="w-7 h-7"></i>
    </button>

    <nav class="mobile-nav fixed bottom-0 left-0 w-full bg-white border-t border-gray-100 pb-safe pt-2 px-6 flex justify-between items-center z-40">
        <button onclick="mudarAba('resumo')" id="mob-tab-resumo" class="flex flex-col items-center gap-1 p-2 w-16 text-brand-600 transition"><i data-lucide="layout-grid" class="w-6 h-6"></i><span class="text-[10px] font-bold">In√≠cio</span></button>
        <button onclick="mudarAba('entradas')" id="mob-tab-entradas" class="flex flex-col items-center gap-1 p-2 w-16 text-gray-400 transition"><i data-lucide="arrow-up-circle" class="w-6 h-6"></i><span class="text-[10px] font-medium">Entrada</span></button>
        <button onclick="mudarAba('saidas')" id="mob-tab-saidas" class="flex flex-col items-center gap-1 p-2 w-16 text-gray-400 transition"><i data-lucide="arrow-down-circle" class="w-6 h-6"></i><span class="text-[10px] font-medium">Sa√≠da</span></button>
    </nav>

    <div id="modal" class="fixed inset-0 bg-gray-900/60 hidden items-end md:items-center justify-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full md:max-w-md md:rounded-3xl rounded-t-3xl p-6 shadow-2xl animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-titulo" class="text-xl font-bold text-gray-800">Nova Transa√ß√£o</h2>
                <button onclick="fecharModal()" class="bg-gray-100 p-2 rounded-full text-gray-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-transacao" class="space-y-4">
                <div class="grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-xl" id="toggle-tipo">
                    <label class="cursor-pointer block"><input type="radio" name="tipo" value="receita" class="peer sr-only" onchange="renderCategorias()"><div class="py-3 text-center rounded-lg text-sm font-bold text-gray-500 peer-checked:bg-white peer-checked:text-green-600 peer-checked:shadow-sm transition">Receita</div></label>
                    <label class="cursor-pointer block"><input type="radio" name="tipo" value="gasto" class="peer sr-only" onchange="renderCategorias()"><div class="py-3 text-center rounded-lg text-sm font-bold text-gray-500 peer-checked:bg-white peer-checked:text-red-600 peer-checked:shadow-sm transition">Despesa</div></label>
                </div>
                <input type="radio" name="tipo" value="investimento" class="hidden" onchange="renderCategorias()">

                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Valor</label>
                    <input type="text" id="valor-mask" placeholder="0,00" onkeyup="mascaraMoeda(this)" class="w-full mt-1 px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-brand-500 outline-none text-2xl font-bold text-gray-800 text-center" required inputmode="numeric">
                </div>
                <div class="space-y-3">
                    <input type="text" id="descricao" placeholder="Descri√ß√£o (ex: Mercado)" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-brand-500 outline-none font-medium" required>
                    <div class="flex gap-2">
                        <select id="categoria" class="flex-1 px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-brand-500 outline-none font-medium appearance-none"></select>
                        <input type="date" id="data-custom" class="w-36 px-2 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-brand-500 outline-none text-sm font-medium text-center">
                    </div>
                </div>
                <button type="submit" id="btn-salvar" class="w-full bg-brand-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-brand-700 active:scale-95 transition shadow-lg mt-2">Salvar</button>
            </form>
        </div>
    </div>

    <div id="modal-edicao" class="fixed inset-0 bg-gray-900/60 hidden items-end md:items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white w-full md:max-w-sm md:rounded-3xl rounded-t-3xl p-6 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-gray-800">Editar</h2>
                <button onclick="document.getElementById('modal-edicao').classList.add('hidden')" class="bg-gray-100 p-2 rounded-full text-gray-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <input type="hidden" id="edit-id">
            <div class="space-y-3">
                <input id="edit-descricao" class="w-full px-4 py-3 border border-gray-200 rounded-xl font-medium focus:border-brand-500 outline-none" placeholder="Descri√ß√£o">
                <input id="edit-valor" onkeyup="mascaraMoeda(this)" class="w-full px-4 py-3 border border-gray-200 rounded-xl font-bold text-gray-800 focus:border-brand-500 outline-none" placeholder="Valor">
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button id="btn-status" onclick="toggleStatus()" class="py-3 rounded-xl bg-gray-100 text-gray-600 font-bold text-sm">Pagar</button>
                <button onclick="deletarItem()" class="py-3 rounded-xl bg-red-50 text-red-600 font-bold text-sm">Excluir</button>
            </div>
            <button onclick="salvarEdicao()" class="w-full mt-3 py-3 rounded-xl bg-brand-600 text-white font-bold hover:bg-brand-700 transition">Salvar Altera√ß√µes</button>
        </div>
    </div>

    <div id="modal-evolucao" class="fixed inset-0 bg-gray-900/60 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl p-6 relative">
            <button onclick="document.getElementById('modal-evolucao').classList.add('hidden')" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full text-gray-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h2 class="font-bold mb-4">Evolu√ß√£o</h2>
            <div class="h-64"><canvas id="graficoEvolucao"></canvas></div>
        </div>
    </div>

    <script>
        const API = '/api/financas';
        let dados = [], dataRef = new Date(), aba = 'resumo', itemEdit = null;
        const CATS = {
            receita: ['Sal√°rio', '13¬∫', 'F√©rias', 'Extra', 'Outros'],
            gasto: ['Casa', 'Mercado', 'Transporte', 'Lazer', 'Sa√∫de', 'Contas', 'Outros'],
            investimento: ['CDB', 'Tesouro', 'A√ß√µes', 'FIIs', 'Reserva', 'Cripto']
        };

        // --- INIT ---
        async function init() {
            const user = localStorage.getItem('usuario_nome') || 'Usu√°rio';
            document.getElementById('mobile-user-name').textContent = user.split(' ')[0];
            document.getElementById('pc-user-name').textContent = user;
            document.getElementById('pc-avatar-initials').textContent = user.charAt(0).toUpperCase();

            // Tenta pegar ultima config
            try {
                const r = await fetch(`${API}?tipo=config`);
                const c = await r.json();
                if(c?.ultimo_mes) { const [a, m] = c.ultimo_mes.split('-'); dataRef = new Date(a, m-1, 1); }
            } catch(e) {}

            renderTituloMes();
            carregar();
        }

        function logout() { localStorage.removeItem('usuario_logado'); window.location.href = '/login.html'; }

        // --- NAVEGA√á√ÉO ---
        function mudarAba(novaAba) {
            aba = novaAba;
            
            // PC: Atualiza Sidebar
            document.querySelectorAll('aside button').forEach(b => {
                b.className = 'w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all';
            });
            const pcBtn = document.getElementById(`pc-tab-${aba}`);
            if(pcBtn) pcBtn.className = 'w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold bg-brand-50 text-brand-600 transition-all';

            // Mobile: Atualiza Bottom Nav
            document.querySelectorAll('.mobile-nav button').forEach(b => {
                b.classList.remove('text-brand-600'); b.classList.add('text-gray-400');
            });
            const mobBtn = document.getElementById(`mob-tab-${aba}`);
            if(mobBtn) { mobBtn.classList.remove('text-gray-400'); mobBtn.classList.add('text-brand-600'); }

            // Visibilidade
            const viewResumo = document.getElementById('view-resumo');
            const viewListas = document.getElementById('view-listas');
            const pageTitle = document.getElementById('page-title');

            if (aba === 'resumo') {
                viewResumo.classList.remove('hidden');
                viewListas.classList.add('hidden');
                pageTitle.textContent = 'Vis√£o Geral';
            } else {
                viewResumo.classList.add('hidden');
                viewListas.classList.remove('hidden');
                renderLista(aba === 'entradas' ? 'receita' : 'gasto');
                pageTitle.textContent = aba === 'entradas' ? 'Receitas' : 'Despesas';
            }
        }

        // --- DADOS ---
        async function carregar() {
            const a = dataRef.getFullYear(), m = String(dataRef.getMonth()+1).padStart(2,'0');
            try {
                const r = await fetch(`${API}?mes=${a}-${m}`);
                dados = await r.json();
                processar();
                document.getElementById('last-update').textContent = 'Atualizado agora';
            } catch(e) { console.error(e); }
        }

        function processar() {
            let r=0, g=0, i=0;
            dados.forEach(d => {
                d.valor = parseFloat(d.valor);
                if(d.tipo==='receita') r+=d.valor;
                else if(d.tipo==='gasto') g+=d.valor;
                else if(d.tipo==='investimento') i+=d.valor;
            });
            
            document.getElementById('total-saldo').textContent = fMoney(r-g);
            document.getElementById('total-renda').textContent = fMoney(r);
            document.getElementById('total-gastos').textContent = fMoney(g);
            document.getElementById('total-investido').textContent = fMoney(i);

            // Investimentos (Sidebar Resumo)
            const divInv = document.getElementById('lista-investimentos'); divInv.innerHTML = '';
            dados.filter(d=>d.tipo==='investimento').forEach(d => {
                // CORRE√á√ÉO CLICK: Passando ID como string segura
                divInv.innerHTML += `<div onclick="abrirEdicao('${d.id}')" class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer border-b border-gray-50 last:border-0"><div class="truncate pr-2"><p class="text-xs font-bold text-gray-700 truncate">${d.descricao}</p><p class="text-[9px] text-gray-400 uppercase">${d.categoria}</p></div><span class="text-xs font-bold text-brand-600">${fMoney(d.valor)}</span></div>`;
            });
            if(!divInv.innerHTML) divInv.innerHTML = '<p class="text-xs text-center text-gray-400 py-4">Vazio</p>';

            // Se estiver na aba de lista, atualiza
            if(aba !== 'resumo') renderLista(aba==='entradas'?'receita':'gasto');
            
            graficos(dados.filter(d=>d.tipo==='gasto'));
        }

        function renderLista(tipo) {
            const div = document.getElementById('lista-content'); div.innerHTML = '';
            const lista = dados.filter(d => d.tipo === tipo);
            
            if(lista.length === 0) {
                div.innerHTML = `<div class="text-center py-10 opacity-50"><i data-lucide="coffee" class="w-8 h-8 mx-auto mb-2"></i><p class="text-sm">Nenhum lan√ßamento</p></div>`;
                lucide.createIcons(); return;
            }

            // Agrupa por data
            const grupos = {};
            lista.forEach(d => {
                const data = new Date(d.data).toLocaleDateString('pt-BR', {day:'2-digit', month:'short'});
                if(!grupos[data]) grupos[data] = []; grupos[data].push(d);
            });

            for(const [dt, itens] of Object.entries(grupos)) {
                // Header Mobile Data
                div.innerHTML += `<div class="lg:hidden flex items-center gap-2 mb-2 mt-4 px-1"><span class="text-[10px] font-bold bg-gray-200 px-2 py-0.5 rounded text-gray-500">${dt}</span><div class="h-px bg-gray-100 flex-1"></div></div>`;
                
                itens.forEach(d => {
                    const cor = tipo==='receita'?'text-green-600':'text-gray-800';
                    const icon = tipo==='receita'?'arrow-up':'arrow-down';
                    
                    // CARD MOBILE / ROW PC
                    // Truque: Classes `lg:hidden` para card mobile, `hidden lg:grid` para row pc
                    const cardMobile = `
                    <div onclick="abrirEdicao('${d.id}')" class="lg:hidden bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer active:scale-[0.98] transition">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 rounded-full ${tipo==='receita'?'bg-green-50 text-green-600':'bg-red-50 text-red-500'} flex items-center justify-center flex-shrink-0"><i data-lucide="${icon}" class="w-5 h-5"></i></div>
                            <div class="truncate">
                                <p class="font-bold text-gray-800 text-sm truncate">${d.descricao}</p>
                                <p class="text-[10px] text-gray-400 uppercase font-bold">${d.categoria}</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="font-bold text-sm ${cor}">${fMoney(d.valor)}</p>
                            ${d.status==='pago' ? '<i data-lucide="check" class="w-3 h-3 text-green-500 ml-auto"></i>' : ''}
                        </div>
                    </div>`;

                    const rowPC = `
                    <div onclick="abrirEdicao('${d.id}')" class="hidden lg:grid pc-table-row">
                        <div class="font-bold text-gray-700 flex items-center gap-3"><div class="w-2 h-2 rounded-full ${d.status==='pago'?'bg-green-500':'bg-orange-400'}"></div> ${d.descricao}</div>
                        <div class="text-sm text-gray-500 bg-gray-50 w-max px-2 py-1 rounded-md text-xs font-bold uppercase">${d.categoria}</div>
                        <div class="text-sm text-gray-500">${new Date(d.data).toLocaleDateString()}</div>
                        <div class="text-right font-bold ${cor}">${fMoney(d.valor)}</div>
                    </div>`;

                    div.innerHTML += cardMobile + rowPC;
                });
            }
            lucide.createIcons();
        }

        // --- EDI√á√ÉO (CORRIGIDO) ---
        function abrirEdicao(id) {
            // Busca segura por ID (string ou number)
            itemEdit = dados.find(d => String(d.id) === String(id)); 
            if(!itemEdit) return;

            document.getElementById('edit-id').value = itemEdit.id;
            document.getElementById('edit-descricao').value = itemEdit.descricao;
            document.getElementById('edit-valor').value = fMoney(itemEdit.valor);
            
            const btn = document.getElementById('btn-status');
            if(itemEdit.status === 'pago') {
                btn.textContent = 'Marcar como Pendente'; btn.className = 'py-3 rounded-xl bg-orange-50 text-orange-600 font-bold text-sm';
            } else {
                btn.textContent = 'Confirmar Pagamento'; btn.className = 'py-3 rounded-xl bg-green-50 text-green-600 font-bold text-sm';
            }

            document.getElementById('modal-edicao').classList.remove('hidden');
        }

        async function salvarEdicao() {
            if(!itemEdit) return;
            const desc = document.getElementById('edit-descricao').value;
            const val = limpaMoney(document.getElementById('edit-valor').value);
            
            await fetch(API, { method: 'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id: itemEdit.id, descricao:desc, valor:val})});
            document.getElementById('modal-edicao').classList.add('hidden'); carregar();
        }

        async function toggleStatus() {
            if(!itemEdit) return;
            const st = itemEdit.status==='pago'?'pendente':'pago';
            await fetch(API, { method: 'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id: itemEdit.id, status:st})});
            document.getElementById('modal-edicao').classList.add('hidden'); carregar();
        }

        async function deletarItem() {
            if(!itemEdit || !confirm('Apagar?')) return;
            await fetch(`${API}?id=${itemEdit.id}`, { method: 'DELETE' });
            document.getElementById('modal-edicao').classList.add('hidden'); carregar();
        }

        // --- ADICIONAR ---
        function abrirModalContexto(tipoFixo) {
            document.getElementById('form-transacao').reset();
            document.getElementById('data-custom').valueAsDate = new Date();
            const divToggle = document.getElementById('toggle-tipo');
            
            if(tipoFixo === 'investimento') {
                document.querySelector('input[value="investimento"]').checked = true;
                divToggle.classList.add('hidden');
                document.getElementById('modal-titulo').textContent = 'Novo Investimento';
            } else {
                divToggle.classList.remove('hidden');
                // Auto-seleciona baseado na aba atual
                if(aba === 'saidas') document.querySelector('input[value="gasto"]').checked = true;
                else document.querySelector('input[value="receita"]').checked = true;
                document.getElementById('modal-titulo').textContent = 'Adicionar';
            }
            renderCategorias();
            document.getElementById('modal').classList.remove('hidden');
        }

        function fecharModal() { document.getElementById('modal').classList.add('hidden'); }

        function renderCategorias() {
            const tipo = document.querySelector('input[name="tipo"]:checked').value;
            const sel = document.getElementById('categoria'); sel.innerHTML = '';
            CATS[tipo].forEach(c => { sel.innerHTML += `<option value="${c}">${c}</option>`; });
        }

        document.getElementById('form-transacao').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dInput = document.getElementById('data-custom').value;
            const dt = dInput ? new Date(dInput+'T12:00:00') : new Date();
            const body = {
                tipo: document.querySelector('input[name="tipo"]:checked').value,
                descricao: document.getElementById('descricao').value,
                valor: limpaMoney(document.getElementById('valor-mask').value),
                categoria: document.getElementById('categoria').value,
                status: 'pago',
                data: dt.toISOString()
            };
            await fetch(API, {method:'POST', body:JSON.stringify(body)});
            fecharModal(); carregar();
        });

        // --- UTIL ---
        function mudarMes(n) { dataRef.setMonth(dataRef.getMonth()+n); renderTituloMes(); carregar(); salvarMes(); }
        function resetarHoje() { dataRef = new Date(); renderTituloMes(); carregar(); salvarMes(); }
        async function salvarMes() { 
            const m = `${dataRef.getFullYear()}-${String(dataRef.getMonth()+1).padStart(2,'0')}`;
            try { await fetch(`${API}?tipo=config`, {method:'POST', body:JSON.stringify({ultimo_mes:m})}); } catch(e){}
        }
        function renderTituloMes() { document.getElementById('mes-titulo').textContent = dataRef.toLocaleDateString('pt-BR',{month:'long', year:'numeric'}); }
        
        function fMoney(v) { return v.toLocaleString('pt-BR',{style:'currency', currency:'BRL'}); }
        function limpaMoney(v) { return parseFloat(v.replace(/\D/g,''))/100; }
        function mascaraMoeda(e) { const v=e.value.replace(/\D/g,"").padStart(3,"0"); e.value = fMoney(parseFloat(v)/100); }

        // --- GRAFICO ---
        let chart = null;
        function graficos(lista) {
            const ctx = document.getElementById('graficoGastos').getContext('2d');
            if(chart) chart.destroy();
            
            const cats = {}; lista.forEach(d=> cats[d.categoria] = (cats[d.categoria]||0)+d.valor);
            const vals = Object.values(cats);
            
            if(vals.length===0) { document.getElementById('grafico-empty').classList.remove('hidden'); return; }
            document.getElementById('grafico-empty').classList.add('hidden');

            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{ data: vals, backgroundColor: ['#10b981','#f59e0b','#ef4444','#3b82f6','#8b5cf6','#ec4899','#6366f1'], borderWidth:0 }]
                },
                options: { cutout: '75%', plugins: { legend: { display: false } } }
            });
        }
        
        // Bonus: Evolu√ß√£o Fake
        let chartEvo = null;
        function abrirModalEvolucao() {
            document.getElementById('modal-evolucao').classList.remove('hidden'); document.getElementById('modal-evolucao').classList.add('flex');
            if(chartEvo) return;
            chartEvo = new Chart(document.getElementById('graficoEvolucao'), {
                type: 'bar',
                data: {
                    labels: ['Out','Nov','Dez','Jan','Fev'],
                    datasets: [{label:'Entrada', data:[5000,5200,6000,5500,5100], backgroundColor:'#10b981', borderRadius:4}, {label:'Sa√≠da', data:[4000,4100,5800,3000,2000], backgroundColor:'#ef4444', borderRadius:4}]
                }, options: { scales: { x:{grid:{display:false}}, y:{display:false} } }
            });
        }

        init();
        lucide.createIcons();
    </script>
</body>
</html>
