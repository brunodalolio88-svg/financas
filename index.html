<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finan√ßas Kynto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active { color: #1e293b; border-bottom: 2px solid #1e293b; font-weight: 700; }
        .tab-inactive { color: #94a3b8; font-weight: 500; }
        .input-invisible { background: transparent; width: 100%; outline: none; }
        .piscar-salvo { animation: flash 0.5s ease-out; }
        @keyframes flash { 0% { background-color: #dcfce7; } 100% { background-color: white; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-28">

    <header class="bg-white sticky top-0 z-30 shadow-sm">
        <div class="flex justify-between items-center px-4 py-3 bg-slate-900 text-white">
            <button onclick="mudarMes(-1)" class="p-1"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
            <div class="flex flex-col items-center cursor-pointer" onclick="resetarHoje()">
                <span id="mes-titulo" class="text-sm font-bold uppercase tracking-widest">Janeiro 2026</span>
                <span id="last-update" class="text-[10px] text-slate-400 opacity-80">Atualizando...</span>
            </div>
            <button onclick="mudarMes(1)" class="p-1"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
        </div>

        <div class="px-5 py-4 border-b border-slate-100">
            <p class="text-xs text-slate-400 font-bold uppercase">Saldo em Caixa</p>
            <h1 id="total-saldo" class="text-3xl font-extrabold text-slate-900 mt-1">R$ 0,00</h1>
            
            <div class="mt-3 flex items-center gap-2">
                <div class="flex-1 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                    <div id="barra-progresso" class="h-full bg-blue-500 w-0 transition-all duration-1000"></div>
                </div>
                <span id="progresso-texto" class="text-[10px] font-bold text-slate-400">0%</span>
            </div>
        </div>

        <nav class="flex text-sm border-b border-slate-100">
            <button onclick="mudarAba('resumo')" id="tab-resumo" class="flex-1 py-3 text-center tab-active transition-all">Resumo</button>
            <button onclick="mudarAba('entradas')" id="tab-entradas" class="flex-1 py-3 text-center tab-inactive transition-all text-green-600">Entradas</button>
            <button onclick="mudarAba('saidas')" id="tab-saidas" class="flex-1 py-3 text-center tab-inactive transition-all text-red-600">Sa√≠das</button>
        </nav>
    </header>

    <main class="max-w-md mx-auto px-4 mt-4">

        <div id="view-resumo" class="space-y-6">
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                    <span class="text-xs font-bold text-green-600 uppercase">Receita</span>
                    <p id="total-renda" class="text-lg font-bold text-slate-800 mt-1">R$ 0,00</p>
                </div>
                <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                    <span class="text-xs font-bold text-red-600 uppercase">Despesa</span>
                    <p id="total-gastos" class="text-lg font-bold text-slate-800 mt-1">R$ 0,00</p>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-4">Para onde foi o dinheiro?</h3>
                <div class="h-40 relative flex justify-center">
                    <canvas id="graficoGastos"></canvas>
                </div>
            </div>

            <div>
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-2 pl-1">√öltimas Movimenta√ß√µes</h3>
                <div id="lista-resumo" class="space-y-2">
                    </div>
                <button onclick="mudarAba('saidas')" class="w-full py-3 text-xs text-blue-600 font-bold mt-2">Ver extrato completo</button>
            </div>
        </div>

        <div id="view-entradas" class="hidden space-y-4">
            </div>

        <div id="view-saidas" class="hidden space-y-4">
            </div>

    </main>

    <button onclick="abrirModal()" class="fixed bottom-6 right-6 bg-slate-900 text-white w-14 h-14 rounded-full shadow-lg shadow-slate-900/40 z-40 active:scale-90 flex items-center justify-center transition-transform">
        <i data-lucide="plus" class="w-7 h-7"></i>
    </button>

    <div id="modal" class="fixed inset-0 bg-black/50 hidden items-end z-50 transition-opacity backdrop-blur-sm">
        <div class="bg-white w-full rounded-t-3xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold">Novo Lan√ßamento</h2>
                <button onclick="fecharModal()" class="bg-slate-100 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <form id="form-transacao" class="space-y-4">
                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="tipo" value="receita" class="peer sr-only" checked>
                        <div class="py-3 text-center rounded-lg text-sm font-bold text-slate-500 peer-checked:bg-white peer-checked:text-green-600 peer-checked:shadow-sm transition-all">Receita</div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="tipo" value="gasto" class="peer sr-only">
                        <div class="py-3 text-center rounded-lg text-sm font-bold text-slate-500 peer-checked:bg-white peer-checked:text-red-600 peer-checked:shadow-sm transition-all">Despesa</div>
                    </label>
                </div>

                <input type="text" id="descricao" placeholder="O que foi?" class="w-full text-lg font-medium border-b border-slate-200 py-3 focus:outline-none focus:border-slate-800 bg-transparent" required>
                
                <div class="flex gap-4">
                    <div class="flex-1">
                        <input type="number" id="valor" step="0.01" placeholder="R$ 0,00" class="w-full text-lg font-medium border-b border-slate-200 py-3 focus:outline-none focus:border-slate-800 bg-transparent" required>
                    </div>
                    <div class="flex-1">
                        <select id="categoria" class="w-full text-lg font-medium border-b border-slate-200 py-3 focus:outline-none focus:border-slate-800 bg-transparent h-[52px]">
                            <option value="Fixa">üè† Fixa</option>
                            <option value="Vari√°vel">üçî Vari√°vel</option>
                            <option value="Renda">üí∞ Renda</option>
                            <option value="Transporte">üöó Transp.</option>
                            <option value="Lazer">üéâ Lazer</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-lg mt-4 active:scale-95 transition-transform">
                    Salvar
                </button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '/api/financas';
        let dataAtual = new Date();
        let chartInstance = null;
        let dadosCache = [];

        // √çcones inteligentes
        const ICON_MAP = {
            'Renda': 'wallet', 'Apartamento': 'building', 'Fixa': 'zap', 
            'Vari√°vel': 'shopping-bag', 'Lazer': 'beer', 'Transporte': 'car', 'default': 'circle-dollar-sign'
        };

        function init() {
            atualizarTituloMes();
            carregarDados();
            lucide.createIcons();
        }

        // --- L√≥gica de Abas ---
        function mudarAba(aba) {
            // Esconde todas views
            ['resumo', 'entradas', 'saidas'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            // Remove active de todas tabs
            ['resumo', 'entradas', 'saidas'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                el.classList.remove('tab-active');
                el.classList.add('tab-inactive');
            });

            // Ativa a selecionada
            document.getElementById(`view-${aba}`).classList.remove('hidden');
            const tabAtiva = document.getElementById(`tab-${aba}`);
            tabAtiva.classList.add('tab-active');
            tabAtiva.classList.remove('tab-inactive');
        }

        // --- Navega√ß√£o M√™s ---
        function mudarMes(delta) {
            dataAtual.setMonth(dataAtual.getMonth() + delta);
            atualizarTituloMes();
            carregarDados();
        }
        function resetarHoje() { dataAtual = new Date(); atualizarTituloMes(); carregarDados(); }
        function atualizarTituloMes() {
            document.getElementById('mes-titulo').textContent = dataAtual.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        }

        // --- Core ---
        async function carregarDados() {
            try {
                const ano = dataAtual.getFullYear();
                const mes = String(dataAtual.getMonth() + 1).padStart(2, '0');
                const res = await fetch(`${API_URL}?mes=${ano}-${mes}`);
                dadosCache = await res.json();
                
                processarDados(dadosCache);
                document.getElementById('last-update').textContent = 'Atualizado √†s ' + new Date().toLocaleTimeString().slice(0,5);
            } catch (e) { console.error(e); }
        }

        function processarDados(dados) {
            let totalRenda = 0, totalGastos = 0;
            const entradas = [], saidas = [];

            dados.forEach(item => {
                item.valor = parseFloat(item.valor);
                if (item.tipo === 'receita') { totalRenda += item.valor; entradas.push(item); }
                else { totalGastos += item.valor; saidas.push(item); }
            });

            // Atualiza Header
            document.getElementById('total-renda').textContent = formatMoney(totalRenda);
            document.getElementById('total-gastos').textContent = formatMoney(totalGastos);
            const saldo = totalRenda - totalGastos;
            document.getElementById('total-saldo').textContent = formatMoney(saldo);
            
            // Barra Progresso
            const pct = totalRenda ? (totalGastos/totalRenda)*100 : 0;
            document.getElementById('barra-progresso').style.width = Math.min(pct, 100) + '%';
            document.getElementById('progresso-texto').textContent = pct.toFixed(0) + '%';

            // Renderiza Listas
            renderizarResumo(dados);
            renderizarListaAgrupada(entradas, 'view-entradas', 'text-green-600');
            renderizarListaAgrupada(saidas, 'view-saidas', 'text-slate-800');
            
            // Gr√°fico
            renderizarGrafico(saidas);
            lucide.createIcons();
        }

        function renderizarListaAgrupada(lista, containerId, corValor) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if(lista.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-slate-400 text-sm">Sem lan√ßamentos</div>';
                return;
            }

            // Agrupar por Data
            const grupos = {};
            lista.forEach(item => {
                const dataObj = new Date(item.data);
                // Ajuste fuso se necess√°rio, ou usar string simples
                const dataKey = dataObj.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'long' });
                if(!grupos[dataKey]) grupos[dataKey] = [];
                grupos[dataKey].push(item);
            });

            // Gerar HTML
            for (const [data, itens] of Object.entries(grupos)) {
                let htmlGrupo = `<div class="mb-2">
                    <h3 class="text-xs font-bold text-slate-400 uppercase bg-slate-50 px-2 py-1 rounded mb-2 sticky top-0">${data}</h3>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden divide-y divide-slate-50">`;
                
                itens.forEach(item => {
                    const icone = ICON_MAP[item.categoria] || ICON_MAP['default'];
                    const isPago = item.status === 'pago';
                    
                    htmlGrupo += `
                    <div id="card-${item.id}" class="p-3 flex items-center gap-3 active:bg-slate-50 transition-colors">
                        <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 flex-shrink-0">
                            <i data-lucide="${icone}" class="w-4 h-4"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <input value="${item.descricao}" onchange="editar(${item.id}, 'descricao', this.value)" class="input-invisible text-sm font-bold text-slate-700 truncate">
                            <input value="${item.categoria}" onchange="editar(${item.id}, 'categoria', this.value)" class="input-invisible text-[10px] text-slate-400 uppercase font-bold">
                        </div>
                        <div class="text-right">
                            <input type="number" step="0.01" value="${item.valor}" onchange="editar(${item.id}, 'valor', this.value)" class="input-invisible text-right text-sm font-bold ${corValor} w-20">
                            <button onclick="editar(${item.id}, 'status', '${isPago?'pendente':'pago'}')" class="text-[10px] ${isPago?'text-green-500':'text-orange-400'} font-bold">
                                ${isPago ? 'PAGO' : 'PENDENTE'}
                            </button>
                        </div>
                        <button onclick="deletar(${item.id})" class="text-slate-300 hover:text-red-500 pl-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`;
                });

                htmlGrupo += `</div></div>`;
                container.innerHTML += htmlGrupo;
            }
        }

        function renderizarResumo(lista) {
            const container = document.getElementById('lista-resumo');
            container.innerHTML = '';
            // Pega os 5 √∫ltimos
            const ultimos = [...lista].sort((a,b) => new Date(b.data) - new Date(a.data)).slice(0, 5);
            
            ultimos.forEach(item => {
                const cor = item.tipo === 'receita' ? 'text-green-600' : 'text-slate-800';
                container.innerHTML += `
                <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-slate-100 text-sm">
                    <span class="font-bold text-slate-700 truncate max-w-[60%]">${item.descricao}</span>
                    <span class="font-bold ${cor}">${formatMoney(item.valor)}</span>
                </div>`;
            });
        }

        // --- Gr√°fico e Utils ---
        function renderizarGrafico(saidas) {
            const ctx = document.getElementById('graficoGastos').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            const cats = {};
            saidas.forEach(i => cats[i.categoria] = (cats[i.categoria] || 0) + i.valor);
            
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{ data: Object.values(cats), backgroundColor: ['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }, cutout: '75%' }
            });
        }

        async function editar(id, campo, valor) {
            const card = document.getElementById(`card-${id}`);
            if(card) card.classList.add('piscar-salvo');
            setTimeout(() => card?.classList.remove('piscar-salvo'), 500);
            
            await fetch(API_URL, { 
                method: 'PUT', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id, [campo]: campo==='valor'?parseFloat(valor):valor})
            });
            carregarDados(); // Recarrega para atualizar totais
        }

        async function deletar(id) {
            if(!confirm("Apagar?")) return;
            await fetch(`${API_URL}?id=${id}`, { method: 'DELETE' });
            carregarDados();
        }

        document.getElementById('form-transacao').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dataReg = new Date(dataAtual.getFullYear(), dataAtual.getMonth(), new Date().getDate(), 12,0,0);
            const form = {
                tipo: document.querySelector('input[name="tipo"]:checked').value,
                descricao: document.getElementById('descricao').value,
                valor: parseFloat(document.getElementById('valor').value),
                categoria: document.getElementById('categoria').value,
                status: 'pago', data: dataReg.toISOString()
            };
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(form) });
            fecharModal(); e.target.reset(); carregarDados();
        });

        function formatMoney(v) { return v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}); }
        function abrirModal() { document.getElementById('modal').classList.remove('hidden'); }
        function fecharModal() { document.getElementById('modal').classList.add('hidden'); }

        init();
    </script>
</body>
</html>
