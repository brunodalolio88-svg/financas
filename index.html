<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanças Kynto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .card-valor { font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 pb-24">

    <header class="bg-blue-900 text-white p-6 rounded-b-3xl shadow-lg sticky top-0 z-10">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold tracking-tight">Finanças Kynto</h1>
            <div class="text-xs opacity-70" id="last-update">Atualizando...</div>
        </div>

        <div class="text-center mb-2">
            <p class="text-sm opacity-80">Saldo Disponível (Recursos)</p>
            <h2 id="total-saldo" class="text-4xl font-bold mt-1 card-valor">R$ 0,00</h2>
        </div>

        <div class="flex gap-4 mt-6">
            <div class="flex-1 bg-white/10 rounded-xl p-3 backdrop-blur-sm">
                <div class="flex items-center gap-2 mb-1">
                    <i data-lucide="arrow-up-circle" class="w-4 h-4 text-green-400"></i>
                    <span class="text-xs font-medium opacity-90">Renda</span>
                </div>
                <p id="total-renda" class="text-lg font-semibold card-valor">R$ 0,00</p>
            </div>
            <div class="flex-1 bg-white/10 rounded-xl p-3 backdrop-blur-sm">
                <div class="flex items-center gap-2 mb-1">
                    <i data-lucide="arrow-down-circle" class="w-4 h-4 text-red-400"></i>
                    <span class="text-xs font-medium opacity-90">Gastos</span>
                </div>
                <p id="total-gastos" class="text-lg font-semibold card-valor">R$ 0,00</p>
            </div>
        </div>
    </header>

    <main class="px-4 mt-6 max-w-2xl mx-auto">
        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">Movimentações</h3>
        <div id="lista-transacoes" class="space-y-3">
            <div class="text-center py-10 text-slate-400">Carregando dados...</div>
        </div>
    </main>

    <button onclick="abrirModal()" class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-xl hover:bg-blue-700 active:scale-95 transition-all z-20">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>

    <div id="modal" class="fixed inset-0 bg-black/60 hidden items-end sm:items-center justify-center z-50 transition-opacity">
        <div class="bg-white w-full sm:max-w-md p-6 rounded-t-3xl sm:rounded-2xl shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">Nova Movimentação</h2>
                <button onclick="fecharModal()" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200">
                    <i data-lucide="x" class="w-5 h-5 text-slate-600"></i>
                </button>
            </div>

            <form id="form-transacao" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <label class="cursor-pointer">
                        <input type="radio" name="tipo" value="receita" class="peer sr-only" checked>
                        <div class="p-3 text-center border-2 border-slate-200 rounded-xl peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 font-medium transition-all">
                            Receita
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="tipo" value="gasto" class="peer sr-only">
                        <div class="p-3 text-center border-2 border-slate-200 rounded-xl peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 font-medium transition-all">
                            Gasto
                        </div>
                    </label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">Descrição</label>
                    <input type="text" id="descricao" placeholder="Ex: Salário Bruno, Condomínio..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500" required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Valor (R$)</label>
                        <input type="number" id="valor" step="0.01" placeholder="0,00" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Categoria</label>
                        <select id="categoria" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500">
                            <option value="Fixa">Conta Fixa</option>
                            <option value="Salário">Salário</option>
                            <option value="Despesas">Despesas</option>
                            <option value="Apartamento">Apartamento</option>
                            <option value="Reembolso">Reembolso</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-200">
                    <input type="checkbox" id="pago" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                    <label for="pago" class="text-slate-700 font-medium select-none">Pagamento já realizado?</label>
                </div>

                <button type="submit" class="w-full bg-blue-900 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-800 transition-colors shadow-lg shadow-blue-900/20">
                    Salvar
                </button>
            </form>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const API_URL = '/api/financas';
        
        // Carregar dados ao iniciar
        document.addEventListener('DOMContentLoaded', carregarDados);

        async function carregarDados() {
            try {
                const res = await fetch(API_URL);
                const dados = await res.json();
                renderizarLista(dados);
                calcularTotais(dados);
                document.getElementById('last-update').textContent = 'Atualizado: ' + new Date().toLocaleTimeString().slice(0,5);
            } catch (erro) {
                console.error("Erro ao carregar:", erro);
            }
        }

        function renderizarLista(itens) {
            const container = document.getElementById('lista-transacoes');
            container.innerHTML = '';

            if (itens.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-slate-400">Nenhuma transação encontrada.</div>';
                return;
            }

            itens.forEach(item => {
                const isReceita = item.tipo === 'receita';
                const valorFormatado = formatarMoeda(item.valor);
                const isPago = item.status === 'pago';
                
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center transition-all hover:shadow-md';
                
                card.innerHTML = `
                    <div class="flex items-center gap-4">
                        <button onclick="alternarStatus(${item.id}, '${isPago ? 'pendente' : 'pago'}')" 
                            class="w-10 h-10 rounded-full flex items-center justify-center transition-colors ${isPago ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-500'}">
                            <i data-lucide="${isPago ? 'check' : 'clock'}" class="w-5 h-5"></i>
                        </button>
                        <div>
                            <h4 class="font-bold text-slate-800">${item.descricao}</h4>
                            <p class="text-xs text-slate-400 font-medium uppercase tracking-wide">${item.categoria}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold ${isReceita ? 'text-green-600' : 'text-slate-800'}">${isReceita ? '+' : '-'} ${valorFormatado}</p>
                        <button onclick="deletarItem(${item.id})" class="text-xs text-red-300 hover:text-red-500 mt-1">Excluir</button>
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function calcularTotais(itens) {
            let renda = 0;
            let gastos = 0;

            itens.forEach(item => {
                const valor = parseFloat(item.valor);
                if (item.tipo === 'receita') renda += valor;
                else if (item.tipo === 'gasto') gastos += valor;
            });

            document.getElementById('total-renda').textContent = formatarMoeda(renda);
            document.getElementById('total-gastos').textContent = formatarMoeda(gastos);
            
            const saldo = renda - gastos;
            const elSaldo = document.getElementById('total-saldo');
            elSaldo.textContent = formatarMoeda(saldo);
            elSaldo.className = `text-4xl font-bold mt-1 card-valor ${saldo < 0 ? 'text-red-300' : 'text-white'}`;
        }

        // Ações do Usuário
        async function deletarItem(id) {
            if(!confirm("Tem certeza que deseja apagar?")) return;
            await fetch(`${API_URL}?id=${id}`, { method: 'DELETE' });
            carregarDados();
        }

        async function alternarStatus(id, novoStatus) {
            await fetch(API_URL, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, status: novoStatus })
            });
            carregarDados();
        }

        document.getElementById('form-transacao').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                tipo: document.querySelector('input[name="tipo"]:checked').value,
                descricao: document.getElementById('descricao').value,
                valor: parseFloat(document.getElementById('valor').value),
                categoria: document.getElementById('categoria').value,
                status: document.getElementById('pago').checked ? 'pago' : 'pendente'
            };

            await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            fecharModal();
            e.target.reset();
            carregarDados();
        });

        // Utils
        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function abrirModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function fecharModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    </script>
</body>
</html>
