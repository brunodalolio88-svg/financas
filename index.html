<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Finanças Bruno & Nathalia</title>

<script>
if (!localStorage.getItem('usuario_logado')) {
  window.location.href = '/login.html';
}
</script>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        brand: {
          500: '#10b981',
          600: '#059669',
          dark: '#064e3b'
        }
      }
    }
  }
}
</script>

<style>
body {
  -webkit-tap-highlight-color: transparent;
  font-family: Inter, system-ui, sans-serif;
  background:#f3f4f6;
}

.hide-scroll::-webkit-scrollbar { display:none }

.skeleton {
  background: linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 37%,#f3f4f6 63%);
  background-size: 400% 100%;
  animation: shimmer 1.4s ease infinite;
}
@keyframes shimmer {
  0% { background-position: 100% 0 }
  100% { background-position: -100% 0 }
}

.input-invisible {
  background:transparent;
  border:none;
  width:100%;
  cursor:pointer;
}
.input-invisible:focus {
  outline:none;
  border-bottom:2px solid #10b981;
  cursor:text;
}

.edit-hint::after {
  content:'✏️';
  opacity:0;
  margin-left:6px;
  font-size:11px;
  transition:.2s;
}
.group:hover .edit-hint::after { opacity:.4 }

.nav-item {
  padding:.5rem 1rem;
  color:rgba(255,255,255,.8);
  font-weight:600;
}
.nav-item.active {
  color:white;
  font-weight:700;
  border-bottom:3px solid white;
}
</style>
</head>

<body class="text-gray-700 pb-24 md:pb-10 pc-resumo" role="application">

<!-- TOAST -->
<div id="toast" class="fixed top-4 right-4 hidden px-4 py-2 rounded-lg text-sm shadow-lg z-50"></div>

<header class="bg-brand-500 sticky top-0 z-30 shadow">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex justify-between items-center h-16">
      <div class="flex items-center gap-3 text-white">
        <div class="bg-white/20 p-2 rounded-lg"><i data-lucide="wallet"></i></div>
        <div>
          <h1 class="font-bold text-lg">Bruno & Nathalia</h1>
          <p class="text-[10px] uppercase opacity-80">Gestão Financeira</p>
        </div>
      </div>

      <div class="flex gap-2">
        <button onclick="mudarMes(-1)" class="text-white/80 hover:text-white"><i data-lucide="chevron-left"></i></button>
        <span id="mes-titulo" class="text-white font-bold text-sm cursor-pointer" onclick="resetarHoje()">...</span>
        <button onclick="mudarMes(1)" class="text-white/80 hover:text-white"><i data-lucide="chevron-right"></i></button>
        <button onclick="logout()" class="text-white/80 hover:text-white"><i data-lucide="log-out"></i></button>
      </div>
    </div>

    <nav class="flex gap-4 mt-2 overflow-x-auto hide-scroll">
      <button id="tab-resumo" class="nav-item active" onclick="mudarAba('resumo')">Visão Geral</button>
      <button id="tab-entradas" class="nav-item" onclick="mudarAba('entradas')">Entradas</button>
      <button id="tab-saidas" class="nav-item" onclick="mudarAba('saidas')">Saídas</button>
    </nav>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 mt-6">

<!-- SKELETON -->
<div id="skeleton-resumo" class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <div class="h-24 rounded-xl skeleton"></div>
  <div class="h-24 rounded-xl skeleton"></div>
  <div class="h-24 rounded-xl skeleton"></div>
</div>

<!-- RESUMO -->
<div id="view-resumo" class="hidden space-y-6">

<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <div class="bg-white rounded-xl p-5 shadow">
    <p class="text-xs uppercase text-gray-400">Receitas</p>
    <p id="total-renda" class="text-2xl font-bold text-green-600">R$ 0,00</p>
  </div>
  <div class="bg-white rounded-xl p-5 shadow">
    <p class="text-xs uppercase text-gray-400">Despesas</p>
    <p id="total-gastos" class="text-2xl font-bold text-red-600">R$ 0,00</p>
  </div>
  <div class="bg-white rounded-xl p-5 shadow border-l-4 border-brand-500">
    <p class="text-xs uppercase text-gray-400">Saldo</p>
    <p id="total-saldo" class="text-3xl font-extrabold">R$ 0,00</p>
  </div>
</div>

<div class="bg-white rounded-xl p-6 shadow">
  <h3 class="font-bold mb-3">Distribuição de Gastos</h3>
  <div class="h-64"><canvas id="graficoGastos"></canvas></div>
</div>

</div>

<!-- LISTAS -->
<div id="view-entradas" class="hidden">
  <div id="lista-entradas-content" class="space-y-3"></div>
</div>

<div id="view-saidas" class="hidden">
  <div id="lista-saidas-content" class="space-y-3"></div>
</div>

</main>

<!-- FAB -->
<button onclick="abrirModalContexto()" class="fixed bottom-6 right-6 bg-brand-500 hover:bg-brand-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center active:scale-95">
  <i data-lucide="plus"></i>
</button>

<script>
const API_URL='/api/financas';
let abaAtiva='resumo';
let dataAtual=new Date();
let chartInstance=null;

function toast(msg,ok=true){
 const t=document.getElementById('toast');
 t.textContent=msg;
 t.className=`fixed top-4 right-4 px-4 py-2 rounded-lg text-sm shadow-lg z-50 ${ok?'bg-green-600':'bg-red-600'}`;
 t.classList.remove('hidden');
 setTimeout(()=>t.classList.add('hidden'),2000);
}

function mostrarLoading(show){
 document.getElementById('skeleton-resumo').style.display=show?'grid':'none';
 document.getElementById('view-resumo').style.display=show?'none':'block';
}

function logout(){
 localStorage.removeItem('usuario_logado');
 location.href='/login.html';
}

function mudarAba(a){
 abaAtiva=a;
 ['resumo','entradas','saidas'].forEach(v=>{
   document.getElementById('view-'+v).classList.add('hidden');
   document.getElementById('tab-'+v).classList.remove('active');
 });
 document.getElementById('view-'+a).classList.remove('hidden');
 document.getElementById('tab-'+a).classList.add('active');
}

async function carregarDados(){
 mostrarLoading(true);
 const r=await fetch(API_URL);
 const d=await r.json();
 processarDados(d);
 mostrarLoading(false);
}

function formatMoney(v){
 return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
}

function processarDados(dados){
 let renda=0,gastos=0;
 const ent=[],sai=[];
 dados.forEach(i=>{
   i.valor=parseFloat(i.valor);
   if(i.tipo==='receita'){renda+=i.valor;ent.push(i);}
   if(i.tipo==='gasto'){gastos+=i.valor;sai.push(i);}
 });
 document.getElementById('total-renda').textContent=formatMoney(renda);
 document.getElementById('total-gastos').textContent=formatMoney(gastos);
 document.getElementById('total-saldo').textContent=formatMoney(renda-gastos);
 renderizarLista(ent,'lista-entradas-content','text-green-600');
 renderizarLista(sai,'lista-saidas-content','text-gray-800');
 renderizarGrafico(sai);
 lucide.createIcons();
}

function renderizarLista(lista,container,cor){
 const c=document.getElementById(container);
 c.innerHTML='';
 if(!lista.length){
   c.innerHTML='<div class="text-center text-gray-400 py-10">Tudo limpo ✨</div>';
   return;
 }
 lista.forEach(i=>{
   c.innerHTML+=`
   <div class="bg-white rounded-xl p-4 shadow flex justify-between items-center group">
     <input class="input-invisible edit-hint font-bold ${cor}" value="${i.descricao}" onchange="editar(${i.id},this.value)">
     <span class="font-bold ${cor}">${formatMoney(i.valor)}</span>
   </div>`;
 });
}

async function editar(id,val){
 await fetch(API_URL,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,descricao:val})});
 toast('Salvo');
 carregarDados();
}

function renderizarGrafico(sai){
 if(chartInstance) chartInstance.destroy();
 const cats={};
 sai.forEach(i=>cats[i.categoria]=(cats[i.categoria]||0)+i.valor);
 const ctx=document.getElementById('graficoGastos').getContext('2d');
 chartInstance=new Chart(ctx,{
   type:'doughnut',
   data:{labels:Object.keys(cats),datasets:[{data:Object.values(cats)}]},
   options:{plugins:{legend:{position:window.innerWidth<768?'bottom':'right'}}}
 });
}

function atualizarTituloMes(){
 document.getElementById('mes-titulo').textContent=
  dataAtual.toLocaleDateString('pt-BR',{month:'short',year:'numeric'});
}

function mudarMes(d){
 dataAtual.setMonth(dataAtual.getMonth()+d);
 atualizarTituloMes();
 carregarDados();
}

function resetarHoje(){
 dataAtual=new Date();
 atualizarTituloMes();
 carregarDados();
}

// Swipe mobile
let startX=0;
document.addEventListener('touchstart',e=>startX=e.touches[0].clientX);
document.addEventListener('touchend',e=>{
 const diff=e.changedTouches[0].clientX-startX;
 if(Math.abs(diff)<80)return;
 if(diff<0 && abaAtiva==='resumo') mudarAba('entradas');
 else if(diff<0 && abaAtiva==='entradas') mudarAba('saidas');
 else if(diff>0 && abaAtiva==='saidas') mudarAba('entradas');
 else if(diff>0 && abaAtiva==='entradas') mudarAba('resumo');
});

atualizarTituloMes();
carregarDados();
</script>

</body>
</html>
